name: Build Moltis Android Binary

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight to check for new versions
  push:
    branches:
      - main
      - vps
  workflow_dispatch:
    inputs:
      moltis_version:
        description: 'Moltis version to build (e.g. v0.9.7)'
        required: true
        default: 'v0.9.7'

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      latest_version: ${{ steps.get-version.outputs.version }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - id: get-version
        run: |
          VERSION=$(curl -s https://api.github.com/repos/moltis-org/moltis/releases/latest | jq -r .tag_name)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Check if already built
        id: check
        run: |
          TAG="${{ steps.get-version.outputs.version }}-termux"
          EXISTS=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG | jq -r .tag_name)
          if [ "$EXISTS" == "null" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Moltis Repo
        uses: actions/checkout@v4
        with:
          repository: moltis-org/moltis
          ref: ${{ github.event.inputs.moltis_version || needs.check-version.outputs.latest_version }}

      - name: Patch Termux SSL + HTTP Client
        run: |
          # ── Patch 1: Inject [env] vars into the process environment ──
          awk '/pub fn apply_env_overrides\(config: MoltisConfig\) -> MoltisConfig \{/ {
            print "#[allow(unsafe_code)]"
            print
            print "    for (k, v) in &config.env {"
            print "        if std::env::var(k).is_err() {"
            print "            unsafe { std::env::set_var(k, v); }"
            print "        }"
            print "    }"
            next
          }1' crates/config/src/loader.rs > tmp.rs && mv tmp.rs crates/config/src/loader.rs

          # ── Patch 2: Overwrite shared_http_client with Hardcoded IP Bypass & HTTP/1.1 ──
          python3 -c "
          import pathlib, textwrap
          pathlib.Path('crates/agents/src/lib.rs').write_text(textwrap.dedent('''
              //! LLM agent runtime: model selection, prompt building, tool execution, streaming.
              #![cfg_attr(feature = \"local-llm\", allow(unsafe_code))]

              pub mod auth_profiles;

              /// Shared HTTP client for LLM providers.
              pub fn shared_http_client() -> &'static reqwest::Client {
                  static CLIENT: std::sync::LazyLock<reqwest::Client> =
                      std::sync::LazyLock::new(|| {
                          println!(\"!!! HTTP CLIENT INIT START (V11 - DRAGON) !!!\");
                          
                          let mut builder = reqwest::ClientBuilder::new()
                              .http1_only()
                              .danger_accept_invalid_certs(true)
                              .user_agent(\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\")
                              .connect_timeout(std::time::Duration::from_secs(30))
                              .tcp_nodelay(true);

                          // Hardcoded IPs for critical domains (Total DNS Bypass)
                          let bips = [
                              (\"openrouter.ai\", [\"104.21.79.160\", \"172.67.13.195\"]),
                              (\"api.cerebras.ai\", [\"104.18.37.159\", \"172.64.150.11\"]),
                              (\"api.groq.com\", [\"104.18.1.151\", \"104.18.0.151\"]),
                              (\"api.github.com\", [\"140.82.121.5\", \"140.82.121.6\"]),
                              (\"raw.githubusercontent.com\", [\"185.199.108.133\", \"185.199.109.133\"])
                          ];

                          for (domain, ips) in bips {
                              for ip in ips {
                                  if let Ok(addr) = ip.parse::<std::net::IpAddr>() {
                                      println!(\"!!! HTTP CLIENT: Resolving {} -> {} !!!\", domain, ip); builder = builder.resolve(domain, std::net::SocketAddr::new(addr, 443));
                                  }
                              }
                          }

                          let cert_path = std::env::var(\"SSL_CERT_FILE\")
                              .ok()
                              .unwrap_or_else(|| \"/data/data/com.termux/files/usr/etc/tls/cert.pem\".into());

                          if let Ok(pem_data) = std::fs::read(&cert_path) {
                              if let Ok(certs) = reqwest::tls::Certificate::from_pem_bundle(&pem_data) {
                                  for cert in certs {
                                      builder = builder.add_root_certificate(cert);
                                  }
                                  println!(\"!!! HTTP CLIENT: Loaded certs from {} !!!\", cert_path);
                              }
                          }

                          let client = builder.build().unwrap_or_else(|e| {
                              println!(\"!!! HTTP CLIENT BUILD ERROR: {} !!!\", e);
                              reqwest::Client::new()
                          });
                          println!(\"!!! HTTP CLIENT INIT COMPLETE (V11 - STABLE) !!!\");
                          client
                      });
                  &CLIENT
              }
              pub mod memory_writer;
              pub mod model;
              pub mod multimodal;
              pub mod prompt;
              pub mod providers;
              pub mod runner;
              pub use {
                  model::{ChatMessage, ContentPart, UserContent},
                  runner::AgentRunError,
              };
              pub mod provider_chain;
              pub mod silent_turn;
              pub mod skills;
              pub mod tool_registry;
          ''').lstrip())
          "

          # -- Patch 2b: Add AGGRESSIVE error printing with robust multiline regex --
          python3 -c "
          import pathlib, re
          
          # 1. Patch startup model discovery & providers
          p_mod = pathlib.Path('crates/agents/src/providers/mod.rs')
          c_mod = p_mod.read_text()
          c_mod = re.sub(r'\.send\(\)\s*\.await\?', '.send().await.map_err(|e| { println!(\"!!! STARTUP DISCOVERY FAILED: {:?} !!!\", e); e })?', c_mod)
          p_mod.write_text(c_mod)

          # 2. Patch chat completions and discovery timeout
          p_ai = pathlib.Path('crates/agents/src/providers/openai.rs')
          c_ai = p_ai.read_text()
          # Increase discovery timeout from 8s to 20s
          c_ai = c_ai.replace('Duration::from_secs(8)', 'Duration::from_secs(20)')
          # Patch .send().await?
          c_ai = re.sub(r'\.send\(\)\s*\.await\?', '.send().await.map_err(|e| { println!(\"!!! LLM REQUEST ERROR: {:?} !!!\", e); e })?', c_ai)
          # Patch .send().await
          c_ai = re.sub(r'\.send\(\)\s*\.await', '.send().await.map_err(|e| { println!(\"!!! LLM STREAM ERROR: {:?} !!!\", e); e })', c_ai)
          p_ai.write_text(c_ai)

          # 3. Patch GitHub update checker to use shared client
          p_srv = pathlib.Path('crates/gateway/src/server.rs')
          c_srv = p_srv.read_text()
          # Replace the entire let client = match ... { ... } block
          c_srv = re.sub(r'let client = match reqwest::Client::builder\(\).*?\.build\(\)\s*\{.*?\};\s*(?=\n\s*loop)', 'let client = moltis_agents::shared_http_client().clone();', c_srv, flags=re.DOTALL)
          p_srv.write_text(c_srv)
          "

          # ── Patch 3: Force version change (Anchored to start of line to avoid dependencies) ──
          find . -name "Cargo.toml" -exec sed -i 's/^version *= \".*\"/version = \"0.9.10-ipv4-v14\"/g' {} +
          echo "Updated all versions to 0.9.10-ipv4-v14"
          
          head -35 crates/agents/src/lib.rs

      - name: Install cross
        uses: taiki-e/install-action@cross

      - name: Build static aarch64-musl
        env:
          RUSTFLAGS: "-C target-feature=+crt-static"
        run: cross build --release --target aarch64-unknown-linux-musl --no-default-features --features "file-watcher, metrics, prometheus, push-notifications, qmd, tailscale, tls, voice, web-ui"

      - name: Build Networking Tools
        run: |
          mkdir -p bin_tools
          
          # ── Setup Zig for Ultra-Reliable Cross-Compilation ───
          echo "Installing Zig..."
          curl -fsSL https://ziglang.org/download/0.13.0/zig-linux-x86_64-0.13.0.tar.xz -o zig.tar.xz
          tar -xf zig.tar.xz
          export PATH=$PWD/zig-linux-x86_64-0.13.0:$PATH
          
          # We use 'zig cc' as a drop-in replacement for aarch64-musl-gcc
          ZIG_TARGET="aarch64-linux-musl"
          
          # ── Build entr ─────────────────────────────────────────
          echo "Building entr..."
          curl -fsSL https://eradman.com/entrproject/code/entr-5.7.tar.gz -o entr.tar.gz
          tar -xzf entr.tar.gz
          cd entr-5.7
          ./configure
          make CC="zig cc -target $ZIG_TARGET" LDFLAGS="-static"
          cp entr ../bin_tools/
          cd ..
          
          # ── Build socat ────────────────────────────────────────
          echo "Building socat..."
          curl -fsSL http://www.dest-unreach.org/socat/download/socat-1.8.0.2.tar.gz -o socat.tar.gz
          tar -xzf socat.tar.gz
          cd socat-1.8.0.2
          # Force zig as the compiler for configure
          CC="zig cc -target $ZIG_TARGET" ./configure --host=aarch64-linux-musl LDFLAGS="-static"
          make -j$(nproc)
          cp socat ../bin_tools/
          cd ..
          
          # ── Build sslh ─────────────────────────────────────────
          echo "Building sslh..."
          curl -fsSL https://github.com/yrutschle/sslh/archive/refs/tags/v1.22c.tar.gz -o sslh.tar.gz
          tar -xzf sslh.tar.gz
          cd sslh-1.22c
          # Force-disable all optional libraries in Makefile by clearing their values
          sed -i 's/USELIBPCRE=.*/USELIBPCRE=/' Makefile
          sed -i 's/USELIBCONFIG=.*/USELIBCONFIG=/' Makefile
          sed -i 's/USELIBWRAP=.*/USELIBWRAP=/' Makefile
          sed -i 's/USELIBCAP=.*/USELIBCAP=/' Makefile
          # Remove any already-defined flags just in case
          sed -i 's/-DLIBPCRE//g' Makefile
          sed -i 's/-lpcre2-8//g' Makefile
          sed -i 's/-DENABLE_REGEX//g' Makefile
          
          echo "Starting sslh-fork compilation..."
          make CC="zig cc -target $ZIG_TARGET" LDFLAGS="-static" sslh-fork
          
          if [ -f sslh-fork ]; then
            cp sslh-fork ../bin_tools/sslh
            echo "SSLH build successful!"
          else
            echo "Error: sslh-fork binary not found!"
            ls -la
            exit 1
          fi
          cd ..

      - name: Package binary
        run: |
          cp target/aarch64-unknown-linux-musl/release/moltis bin_tools/
          tar -czvf moltis-termux-aarch64.tar.gz -C bin_tools .

      - name: Release Termux Binary
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.moltis_version || needs.check-version.outputs.latest_version }}-termux-vps
          name: Termux VPS Build ${{ github.event.inputs.moltis_version || needs.check-version.outputs.latest_version }}
          files: moltis-termux-aarch64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
